<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Gas Breaker</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Libre+Baskerville:wght@700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: #f8f4ef; font-family: 'Nunito', sans-serif; color: #2d2420; -webkit-tap-highlight-color: transparent; }
    body.display-mode { background: #130f0d; }
    body.display-mode .header { background: #1e1a17; border-bottom-color: #3d3530; }
    body.display-mode .logo-text { color: #f5f0eb; }
    body.display-mode .logo-sub  { color: #7c6c62; }
    body.display-mode .sync-pip  { box-shadow: 0 0 8px #4ade8099; }
    body.display-mode .chip { border: 1.5px solid #3d3530; }
    body.display-mode .summary-bar { max-width: none; background: #1e1a17; padding: 8px 14px; border-bottom: 1px solid #3d3530; }
    button, select, input { font-family: inherit; }
    button { cursor: pointer; }
    button:active { opacity: 0.82; transform: scale(0.96); }
    #app { min-height: 100vh; padding-bottom: 60px; }

    /* â”€â”€ Header â”€â”€ */
    .header { background: #fff; border-bottom: 1px solid #e8e0d6; position: sticky; top: 0; z-index: 40; box-shadow: 0 1px 8px rgba(0,0,0,0.06); }
    .header-inner { max-width: 780px; margin: 0 auto; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .logo-wrap { display: flex; align-items: center; gap: 10px; }
    .logo-icon { font-size: 26px; }
    .logo-text { font-family: 'Libre Baskerville', serif; font-weight: 700; font-size: 19px; color: #2d2420; line-height: 1; }
    .logo-sub  { font-size: 11px; color: #a39688; margin-top: 2px; }
    .header-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .sync-pip { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; box-shadow: 0 0 6px #4ade8099; flex-shrink: 0; }
    .sync-pip.offline { background: #f87171; box-shadow: 0 0 6px #f8717199; }
    .dept-name { font-size: 13px; color: #7c6c62; font-weight: 700; }
    .display-link { font-size: 12px; color: #a39688; font-weight: 700; text-decoration: none; border: 1.5px solid #e8e0d6; border-radius: 8px; padding: 4px 10px; white-space: nowrap; }
    .display-link:hover { background: #f1ede8; }
    .logout-btn { font-size: 12px; color: #a39688; font-weight: 700; background: none; border: 1.5px solid #e8e0d6; border-radius: 8px; padding: 4px 10px; white-space: nowrap; }
    .logout-btn:hover { background: #f1ede8; }

    /* â”€â”€ Summary bar â”€â”€ */
    .summary-bar { max-width: 780px; margin: 0 auto; padding: 8px 16px; display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .chip { display: flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; white-space: nowrap; flex-shrink: 0; cursor: pointer; border: 2px solid transparent; transition: border-color 0.15s, box-shadow 0.15s; }
    .chip.filter-rooms { cursor: default; }
    .chip.active-filter { border-color: currentColor; box-shadow: 0 0 0 2px rgba(0,0,0,0.08); }
    .chip-dot   { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .chip-count { font-size: 13px; font-weight: 900; }

    /* Phone board: filtered-out cards collapse */
    .or-card.filter-done { display: none; }

    /* Display board: filtered-out cards dim, needed cards get bright border */
    .or-card.display-card.filter-done  { opacity: 0.2; }
    .or-card.display-card.filter-needs { border-color: #facc15 !important; box-shadow: 0 0 0 2px #facc1540; }

    /* â”€â”€ Main board â”€â”€ */
    .main { max-width: 780px; margin: 0 auto; padding: 10px 16px; }

    /* â”€â”€ OR Card â”€â”€ */
    .or-card {
      background: #fff; border: 1.5px solid #e8e0d6;
      border-radius: 14px; padding: 12px 14px; margin-bottom: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      transition: border-color 0.2s, background 0.2s, opacity 0.2s;
    }
    .or-card.hold       { border-color: #fca5a5; background: #fff5f5; }
    .or-card.hold-warn  { border-color: #fcd34d; background: #fffbeb; }
    .or-card.requesting { border-color: #5eead4; background: #f0fdfa; }
    .or-card.hold.requesting      { border-color: #fca5a5; background: #fff5f5; }
    .or-card.hold-warn.requesting { border-color: #fcd34d; background: #fffbeb; }
    .or-card.empty   { opacity: 0.5; background: #f5f2ef; border-color: #e2dcd6; }
    .or-card.empty.editing { opacity: 1; background: #fff; border-color: #b45309; }

    /* Card layout â€” vertical stack */
    .card-inner { display: flex; align-items: flex-start; gap: 8px; }
    .card-body  { flex: 1; min-width: 0; }
    .room-label { font-family: 'Libre Baskerville', serif; font-weight: 700; font-size: 15px; color: #2d2420; display: block; margin-bottom: 3px; line-height: 1.2; }

    /* Provider name / assign */
    .provider-name-btn {
      background: none; border: none; padding: 0;
      font-size: 13px; font-weight: 700; color: #7c6c62;
      text-align: left; display: block; width: 100%;
      line-height: 1.3; margin-bottom: 7px;
    }
    .provider-name-btn.empty { color: #c4b8ad; font-weight: 600; font-style: italic; }
    .provider-name-btn.requesting-name { color: #0f766e; }
    .provider-input-wrap { position: relative; margin-bottom: 7px; }
    .provider-input { width: 100%; background: #faf7f4; border: 1.5px solid #b45309; border-radius: 8px; padding: 6px 10px; font-size: 13px; font-weight: 700; color: #2d2420; outline: none; font-family: inherit; }
    .roster-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; background: #fff; border: 1.5px solid #e8e0d6; border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; margin-top: 2px; }
    .roster-option { padding: 9px 12px; font-size: 13px; font-weight: 700; color: #2d2420; cursor: pointer; border: none; background: none; width: 100%; text-align: left; border-bottom: 1px solid #f1ede8; }
    .roster-option:last-child { border-bottom: none; }
    .roster-option:hover { background: #f8f4ef; }
    .roster-option.clear-opt { color: #dc2626; font-style: italic; }

    /* No-break slot card */
    .or-card.no-break-card { padding: 8px 14px; min-height: unset; }
    .no-break-label { font-size: 12px; color: #a39688; font-family: 'Nunito', sans-serif; font-weight: 800; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 2px; }
    .no-break-card .provider-name-btn { margin-bottom: 0; font-size: 13px; }

    /* No-break section divider */
    .no-break-section { margin-bottom: 10px; }
    .no-break-section-label { font-size: 11px; font-weight: 800; color: #c4b8ad; text-transform: uppercase; letter-spacing: 0.5px; padding: 0 2px; margin-bottom: 6px; }
    .or-section-divider { border: none; border-top: 1px dashed #e8e0d6; margin: 10px 0; }

    /* Break pills */
    .pill-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .pill { border-radius: 8px; padding: 5px 12px; font-size: 12px; border: 1.5px solid #e8e0d6; background: #f1ede8; color: #c4b8ad; font-family: inherit; font-weight: 600; cursor: pointer; transition: none; }
    .pill.done { background: #dcfce7; color: #15803d; border-color: #86efac; font-weight: 700; }

    /* Side buttons */
    .card-side { display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; }
    .side-btn { border: 1.5px solid #e8e0d6; border-radius: 8px; padding: 5px 9px; font-size: 11px; font-weight: 800; white-space: nowrap; background: #f1ede8; color: #a39688; min-width: 52px; text-align: center; }
    .side-btn.hold-on    { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }
    .side-btn.hold-warn  { background: #fef3c7; color: #b45309; border-color: #fcd34d; }
    .side-btn.request-on { background: #f0fdfa; color: #0f766e; border-color: #5eead4; }

    /* Requesting banner */
    .requesting-banner { background: #f0fdfa; color: #0f766e; border: 1px solid #99f6e4; border-radius: 8px; padding: 4px 10px; font-size: 11px; font-weight: 800; margin-bottom: 8px; }

    /* â”€â”€ Auth screens â”€â”€ */
    .auth-root { min-height: 100vh; background: #f8f4ef; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .auth-card { background: #fff; border: 1.5px solid #e8e0d6; border-radius: 20px; padding: 32px 28px; width: 100%; max-width: 380px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); text-align: center; }
    .auth-title { font-family: 'Libre Baskerville', serif; font-weight: 700; font-size: 26px; color: #2d2420; margin-bottom: 4px; }
    .auth-sub   { font-size: 14px; color: #a39688; }
    .auth-divider { height: 1px; background: #e8e0d6; margin: 20px 0; }

    /* â”€â”€ Form elements â”€â”€ */
    label.field-label { display: block; font-size: 12px; font-weight: 800; color: #7c6c62; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; text-align: left; }
    .field-label.mt { margin-top: 14px; }
    input.text-input, select.text-input { width: 100%; background: #faf7f4; border: 1.5px solid #e8e0d6; border-radius: 10px; padding: 11px 13px; font-size: 14px; color: #2d2420; outline: none; font-family: inherit; font-weight: 700; }
    input.text-input.code-input { text-transform: uppercase; letter-spacing: 3px; text-align: center; font-size: 18px; font-weight: 800; }
    .error-msg { font-size: 12px; color: #dc2626; background: #fee2e2; border-radius: 8px; padding: 8px 12px; margin-top: 4px; font-weight: 700; text-align: left; }
    .btn-primary { background: #2d2420; color: #fff; border: none; border-radius: 10px; padding: 10px 18px; font-size: 14px; font-weight: 800; }
    .btn-primary.mt { margin-top: 16px; width: 100%; padding: 14px; font-size: 16px; }
    .btn-primary.full { width: 100%; padding: 14px; font-size: 16px; margin-top: 20px; }
    .btn-ghost  { background: #f1ede8; color: #7c6c62; border: none; border-radius: 10px; padding: 10px 18px; font-size: 14px; font-weight: 800; }
    .btn-danger { background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; padding: 6px 12px; font-size: 12px; font-weight: 800; }
    .btn-warn   { background: #fef3c7; color: #b45309; border: 1.5px solid #fcd34d; border-radius: 10px; padding: 10px 18px; font-size: 14px; font-weight: 800; width: 100%; margin-top: 8px; }
    .btn-row { display: flex; gap: 8px; }

    /* â”€â”€ Admin â”€â”€ */
    .admin-root { max-width: 680px; margin: 0 auto; padding: 20px 16px 60px; }
    .admin-section { background: #fff; border: 1.5px solid #e8e0d6; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
    .admin-section-title { font-family: 'Libre Baskerville', serif; font-weight: 700; font-size: 17px; color: #2d2420; margin-bottom: 4px; }
    .admin-section-sub   { font-size: 12px; color: #a39688; margin-bottom: 16px; }
    .admin-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .admin-list-item { display: flex; align-items: center; gap: 8px; background: #f8f4ef; border-radius: 8px; padding: 10px 12px; font-size: 14px; font-weight: 700; color: #2d2420; }
    .admin-list-item.dragging  { opacity: 0.4; }
    .admin-list-item.drag-over { border: 2px dashed #b45309; }
    .drag-handle { color: #c4b8ad; font-size: 16px; cursor: grab; padding: 0 2px; user-select: none; flex-shrink: 0; }
    .admin-add-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .admin-add-input { flex: 1; min-width: 120px; background: #faf7f4; border: 1.5px solid #e8e0d6; border-radius: 10px; padding: 10px 13px; font-size: 14px; color: #2d2420; outline: none; font-family: inherit; font-weight: 700; }
    .admin-back-btn { background: none; border: none; color: #7c6c62; font-size: 13px; font-weight: 800; padding: 0; }
    .dept-badge { font-size: 11px; font-weight: 800; background: #f1ede8; color: #a39688; border-radius: 6px; padding: 2px 7px; margin-left: 6px; }

    /* â”€â”€ Confirm dialog â”€â”€ */
    .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .confirm-box { background: #fff; border-radius: 16px; padding: 24px; max-width: 340px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
    .confirm-title { font-family: 'Libre Baskerville', serif; font-weight: 700; font-size: 17px; color: #2d2420; margin-bottom: 8px; }
    .confirm-msg   { font-size: 13px; color: #7c6c62; margin-bottom: 20px; line-height: 1.5; }

    /* â”€â”€ Request notification (coordinator display) â”€â”€ */
    .request-notification {
      position: fixed; top: 80px; right: 16px; z-index: 90;
      background: #0f766e; color: #fff; border-radius: 14px;
      padding: 14px 18px; max-width: 280px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      font-weight: 800; font-size: 14px;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from { transform: translateX(120%); opacity:0; } to { transform: translateX(0); opacity:1; } }
    .request-notification .notif-room { font-size: 18px; font-family: 'Libre Baskerville', serif; }
    .request-notification .notif-sub  { font-size: 12px; font-weight: 600; opacity: 0.85; margin-top: 2px; }
    .request-notification .notif-dismiss { margin-top: 10px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: #fff; font-size: 12px; font-weight: 800; padding: 4px 10px; cursor: pointer; }
    .request-notification .notif-timer-bar { height: 3px; background: rgba(255,255,255,0.5); border-radius: 2px; width: 100%; margin-top: 8px; }

    /* â”€â”€ Coordinator display layout â”€â”€ */
    .display-outer { padding: 10px 14px 40px; max-width: 1600px; margin: 0 auto; }

    /* No-break row â€” horizontal strip at top */
    .display-nobreak-row {
      display: flex; flex-wrap: wrap; gap: 8px;
      margin-bottom: 4px;
    }
    .display-nobreak-row .or-card.no-break-card {
      flex: 0 0 auto; width: 180px;
      padding: 6px 10px;
      min-height: unset !important;
      background: #1e1a17; border-color: #3d3530;
    }
    .display-nobreak-row .no-break-label { font-size: 10px; margin-bottom: 1px; color: #7c6c62; }
    .display-nobreak-row .provider-name-btn { font-size: 13px; font-weight: 800; line-height: 1.2; margin-bottom: 0; color: #e8ddd6; }
    .display-nobreak-row .or-card.no-break-card.empty { opacity: 0.4; }
    .display-divider { border: none; border-top: 2px dashed #3d3530; margin: 8px 0 10px; }

    /* OR columns */
    .display-wrap {
      column-count: 4;
      column-gap: 10px;
    }
    @media (max-width: 1200px) { .display-wrap { column-count: 3; } }
    @media (max-width: 860px)  { .display-wrap { column-count: 2; } }
    @media (max-width: 500px)  { .display-wrap { column-count: 1; } }

    /* Display cards â€” bold dark theme */
    .or-card.display-card {
      break-inside: avoid;
      margin-bottom: 10px;
      padding: 12px 14px;
      min-height: 120px;
      background: #1e1a17;
      border: 2px solid #3d3530;
      box-shadow: none;
    }
    .or-card.display-card.empty   { background: #181410; border-color: #2a2420; opacity: 0.45; }
    .or-card.display-card.hold      { background: #3b1515; border-color: #dc2626; }
    .or-card.display-card.hold-warn { background: #3b2e00; border-color: #f59e0b; }
    .or-card.display-card.requesting { background: #063b33; border-color: #10b981; }

    .display-card .room-label { font-size: 14px; font-weight: 900; color: #a39688; letter-spacing: 0.3px; }
    .display-card .provider-name-btn { font-size: 16px; font-weight: 900; color: #f5f0eb; margin-bottom: 8px; }
    .display-card .provider-name-btn.empty { color: #4a4240; font-weight: 700; }
    .display-card .provider-name-btn.requesting-name { color: #34d399; }

    .display-card .pill {
      font-size: 12px; padding: 5px 11px; font-weight: 800;
      background: #2d2825; border-color: #4a4240; color: #6b5e57;
    }
    .display-card .pill.done {
      background: #064e3b; color: #34d399; border-color: #059669;
    }
    .display-card .side-btn { font-size: 11px; padding: 5px 8px; min-width: 48px; background: #2d2825; border-color: #4a4240; color: #7c6c62; }
    .display-card .side-btn.hold-on   { background: #7f1d1d; color: #fca5a5; border-color: #dc2626; }
    .display-card .side-btn.hold-warn { background: #78350f; color: #fcd34d; border-color: #f59e0b; }
    .display-card .side-btn.request-on { background: #064e3b; color: #34d399; border-color: #059669; }
    .display-card .requesting-banner { background: #064e3b; color: #34d399; border-color: #059669; font-size: 11px; }

    /* â”€â”€ Toast â”€â”€ */
    #toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #2d2420; color: #fff; padding: 10px 20px; border-radius: 24px; font-size: 13px; font-weight: 800; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 200; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>
<div id="app"></div>
<div id="toast"></div>

<script type="module">
import { initializeApp }                                           from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, set, get, remove, push, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// â”€â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey:            "AIzaSyBzSQU4RoSGGoPgbcMDUHIDxAl3PAqBqsk",
  authDomain:        "gas-breaker.firebaseapp.com",
  databaseURL:       "https://gas-breaker-default-rtdb.firebaseio.com",
  projectId:         "gas-breaker",
  storageBucket:     "gas-breaker.firebasestorage.app",
  messagingSenderId: "502120571871",
  appId:             "1:502120571871:web:710d607cbc4bb0fb52da6a"
};
const firebaseApp = initializeApp(firebaseConfig);
const db          = getDatabase(firebaseApp);

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ADMIN_CODE     = "GBADMIN";
const SESSION_KEY    = "gasbreaker-session-v4";
const HOLD_WARN_MS   = 15 * 60 * 1000; // 15 min â†’ amber warning
const HOLD_CLEAR_MS  = 20 * 60 * 1000; // 20 min â†’ auto-release

const DEFAULT_LOCATIONS = [
  "Main OR 1","Main OR 2","Main OR 3","Main OR 4","Main OR 5",
  "Main OR 6","Main OR 7","Main OR 8","Main OR 9","Main OR 10","Main OR 11",
  "Walters OR 1","Walters OR 2","Walters OR 3","Walters OR 4","Walters OR 5",
  "Walters OR 6","Walters OR 7","Walters OR 8","Walters OR 9",
  "Radiology","Floating",
];

const BREAKS = [
  { id: "am",    label: "AM"    },
  { id: "lunch", label: "Lunch" },
  { id: "pm",    label: "PM"    },
];

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let session     = null;   // { deptCode, deptName, isAdmin? }
let boardData   = {};     // { [roomId]: { provider, breaks, hold, holdAt, requesting, hidden } }
let locations     = [...DEFAULT_LOCATIONS];
let noBreakSlots  = [];   // e.g. ["Breaker 1", "Breaker 2", "Float"]
let roster        = [];
let departments   = {};
let isDisplayMode = false;
let activeFilter    = null;   // null | "am" | "lunch" | "pm"
let providerHistory = {};    // { [nameKey]: { am?, lunch?, pm? } } â€” persists all day

let unsubBoard  = null;
let unsubConfig = null;
let unsubDepts  = null;

// â”€â”€â”€ Firebase refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tsDay      = () => { const d = new Date(); return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; };
const boardRef   = (code) => ref(db, `boards/${code}/${tsDay()}`);
const configRef  = (code) => ref(db, `config/${code}`);
const deptsRef   = ()     => ref(db, `departments`);

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rosterMatches(name, query) {
  if (!query) return true;
  const q = query.toLowerCase(), n = name.toLowerCase();
  if (n.startsWith(q)) return true;
  const ci = n.indexOf(",");
  if (ci !== -1 && n.slice(ci + 1).trimStart().startsWith(q)) return true;
  return false;
}

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg; t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove("show"), 2500);
}

// â”€â”€â”€ Confirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showConfirm(title, msg, onConfirm) {
  const overlay = el("div", { class: "confirm-overlay" },
    el("div", { class: "confirm-box" },
      el("div", { class: "confirm-title" }, title),
      el("div", { class: "confirm-msg" }, msg),
      el("div", { class: "btn-row" },
        el("button", { class: "btn-danger", style: { flex:"1", padding:"10px" }, onClick: () => { overlay.remove(); onConfirm(); } }, "Yes, delete"),
        el("button", { class: "btn-ghost",  style: { flex:"1" }, onClick: () => overlay.remove() }, "Cancel"),
      ),
    )
  );
  document.body.appendChild(overlay);
}

// â”€â”€â”€ DOM helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function el(tag, attrs, ...children) {
  const e = document.createElement(tag);
  for (const [k, v] of Object.entries(attrs || {})) {
    if (k === "class")           e.className = v;
    else if (k === "style")      Object.assign(e.style, v);
    else if (k === "disabled")   e.disabled = !!v;
    else if (k.startsWith("on")) e.addEventListener(k.slice(2).toLowerCase(), v);
    else e.setAttribute(k, v);
  }
  for (const c of children.flat()) {
    if (c == null) continue;
    e.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  }
  return e;
}

// â”€â”€â”€ Subscribe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function subscribeToDepartments(cb) {
  if (unsubDepts) unsubDepts();
  let cbCalled = false;
  unsubDepts = onValue(deptsRef(), snap => {
    departments = snap.val() || {};
    if (cb && !cbCalled) { cbCalled = true; cb(); }
    // After initial load, silently update departments without re-rendering
  });
}

function subscribeToBoard(deptCode) {
  if (unsubBoard)  unsubBoard();
  if (unsubConfig) unsubConfig();

  let boardInitialized = false;

  unsubBoard = onValue(boardRef(deptCode), snap => {
    boardData = snap.val() || {};
    // Sync providerHistory from _hist_ keys in boardData
    providerHistory = {};
    Object.entries(boardData).forEach(([k, v]) => {
      if (k.startsWith("_hist_") && v?.provider) providerHistory[v.provider] = v.breaks || {};
    });
    checkAutoUnhold();
    if (!boardInitialized) {
      boardInitialized = true;
      renderBoard();
    } else if (document.querySelector(".main"))              renderBoard();
    else if (document.querySelector(".display-outer"))       renderDisplay();
  }, err => {
    console.error("Board error:", err);
    document.querySelector(".sync-pip")?.classList.add("offline");
  });

  unsubConfig = onValue(configRef(deptCode), snap => {
    const cfg = snap.val() || {};
    locations    = cfg.locations    ? Object.values(cfg.locations)    : [...DEFAULT_LOCATIONS];
    noBreakSlots = cfg.noBreakSlots ? Object.values(cfg.noBreakSlots) : [];
    roster       = cfg.roster       ? Object.values(cfg.roster).sort() : [];
    // Only re-render if board is showing â€” not if on admin page
    if (document.querySelector(".main"))              renderBoard();
    else if (document.querySelector(".display-outer")) renderDisplay();
  });
}

// â”€â”€â”€ Auto-unhold check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAutoUnhold() {
  const now = Date.now();
  Object.entries(boardData).forEach(([rid, room]) => {
    if (room.hold && room.holdAt && (now - room.holdAt) >= HOLD_CLEAR_MS) {
      writeRoom(rid, r => ({ ...r, hold: false, holdAt: null }));
    }
  });
}

// â”€â”€â”€ Write helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function writeRoom(roomId, updater) {
  if (!session?.deptCode) return;
  const r    = ref(db, `boards/${session.deptCode}/${tsDay()}/${roomId}`);
  const snap = await get(r);
  const current = snap.val() || {};
  await set(r, updater(current));
}

async function saveLocations(locs) {
  const obj = {}; locs.forEach((l, i) => { obj[i] = l; });
  await set(ref(db, `config/${session.deptCode}/locations`), obj);
}

async function saveNoBreakSlots(slots) {
  const obj = {}; slots.forEach((s, i) => { obj[i] = s; });
  await set(ref(db, `config/${session.deptCode}/noBreakSlots`), obj);
}

async function saveRosterEntry(name) {
  await push(ref(db, `config/${session.deptCode}/roster`), name);
}

async function deleteRosterEntry(name) {
  const snap = await get(ref(db, `config/${session.deptCode}/roster`));
  const data = snap.val() || {};
  for (const [k, v] of Object.entries(data)) {
    if (v === name) { await remove(ref(db, `config/${session.deptCode}/roster/${k}`)); break; }
  }
}

async function saveDepartment(code, name) {
  await set(ref(db, `departments/${code}`), name);
}

async function deleteDepartment(code) {
  await remove(ref(db, `departments/${code}`));
  await remove(ref(db, `config/${code}`));
  await remove(ref(db, `boards/${code}`));
}

async function renameDepartmentCode(oldCode, newCode, name) {
  // 1. Read all existing data under old code
  const [cfgSnap, boardsSnap] = await Promise.all([
    get(ref(db, `config/${oldCode}`)),
    get(ref(db, `boards/${oldCode}`)),
  ]);

  // 2. Write dept entry under new code
  await set(ref(db, `departments/${newCode}`), name);

  // 3. Copy config to new code (if any)
  if (cfgSnap.exists()) {
    await set(ref(db, `config/${newCode}`), cfgSnap.val());
  }

  // 4. Copy boards to new code (if any)
  if (boardsSnap.exists()) {
    await set(ref(db, `boards/${newCode}`), boardsSnap.val());
  }

  // 5. Delete old code paths
  await remove(ref(db, `departments/${oldCode}`));
  await remove(ref(db, `config/${oldCode}`));
  await remove(ref(db, `boards/${oldCode}`));
}

// â”€â”€â”€ Room ID â€” stable key from location name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function roomId(loc) {
  return loc.replace(/[^a-zA-Z0-9]/g, "_");
}

// â”€â”€â”€ Provider history helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function providerKey(name) {
  return "_hist_" + name.replace(/[^a-zA-Z0-9]/g, "_");
}

async function saveProviderBreaks(name, breaks) {
  if (!session?.deptCode || !name) return;
  const key = providerKey(name);
  await set(ref(db, `boards/${session.deptCode}/${tsDay()}/${key}`), { provider: name, breaks });
}

function getProviderHistory(name) {
  return providerHistory[name] || {};
}

// â”€â”€â”€ Board actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function assignProvider(loc, name) {
  const targetId = roomId(loc);

  // Always restore breaks from provider's day history
  const restoredBreaks = getProviderHistory(name);

  // If provider is already in another room, clear that room first
  const existingEntry = Object.entries(boardData).find(
    ([id, room]) => room.provider === name && id !== targetId && !id.startsWith("nb_") && !id.startsWith("_hist_")
  );
  if (existingEntry) {
    const [oldId] = existingEntry;
    const oldRef = ref(db, `boards/${session.deptCode}/${tsDay()}/${oldId}`);
    const oldSnap = await get(oldRef);
    await set(oldRef, { ...(oldSnap.val()||{}), provider: null, breaks: {}, hold: false, holdAt: null, requesting: false });
  }

  await writeRoom(targetId, r => ({
    ...r,
    location: loc,
    provider: name,
    breaks: restoredBreaks,
    hold: false, holdAt: null, requesting: false,
  }));
}

async function clearProvider(loc) {
  const id = roomId(loc);
  await writeRoom(id, () => ({ location: loc, provider: null, breaks: {}, hold: false, holdAt: null, requesting: false }));
}

async function toggleBreak(loc, breakId) {
  const id = roomId(loc);
  const room = boardData[id] || {};
  const breaks = { ...(room.breaks || {}) };
  if (breaks[breakId]) delete breaks[breakId];
  else breaks[breakId] = Date.now();
  await writeRoom(id, r => ({ ...r, breaks }));
  // Also persist to provider history so breaks follow them if moved
  if (room.provider) await saveProviderBreaks(room.provider, breaks);
}

async function toggleHold(loc) {
  const id = roomId(loc);
  const now = Date.now();
  const current = boardData[id] || {};
  const turningOn = !current.hold;
  const r = ref(db, `boards/${session.deptCode}/${tsDay()}/${id}`);
  const snap = await get(r);
  const data = snap.val() || {};
  await set(r, {
    ...data,
    hold:       turningOn,
    holdAt:     turningOn ? now   : null,
    requesting: turningOn ? false : (data.requesting || false),
  });
}

async function toggleRequesting(loc) {
  const id = roomId(loc);
  const current = boardData[id] || {};
  const turningOn = !current.requesting;
  const r = ref(db, `boards/${session.deptCode}/${tsDay()}/${id}`);
  const snap = await get(r);
  const data = snap.val() || {};
  await set(r, {
    ...data,
    requesting: turningOn,
    hold:       turningOn ? false : (data.hold || false),
    holdAt:     turningOn ? null  : (data.holdAt || null),
  });
}

async function clearBoard() {
  await set(boardRef(session.deptCode), {});
}

// â”€â”€â”€ Roster dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildProviderInput(currentName, loc, card, onDone, onTab) {
  const wrap  = el("div", { class: "provider-input-wrap" });
  const input = el("input", { class: "provider-input", type: "text", value: "", placeholder: "Search roster...", autocomplete: "off" });
  let dropdown = null;

  // Immediately make card look active/normal (remove grayed out empty state)
  if (card) { card.classList.remove("empty"); card.classList.add("editing"); }

  function closeDropdown() { if (dropdown) { dropdown.remove(); dropdown = null; } }

  function showDropdown(query) {
    closeDropdown();
    const matches = query ? roster.filter(n => rosterMatches(n, query)) : roster;
    dropdown = el("div", { class: "roster-dropdown" });

    // Remove provider option at top if room is occupied
    if (currentName) {
      const clearOpt = el("button", { class: "roster-option clear-opt", type: "button" }, "âœ• Remove provider");
      clearOpt.addEventListener("mousedown", async e => {
        e.preventDefault();
        closeDropdown();
        await clearProvider(loc);
        onDone();
      });
      dropdown.appendChild(clearOpt);
    }

    matches.slice(0, 12).forEach(name => {
      const opt = el("button", { class: "roster-option", type: "button" }, name);
      opt.addEventListener("mousedown", async e => {
        e.preventDefault();
        closeDropdown();
        await assignProvider(loc, name);
        onDone();
      });
      dropdown.appendChild(opt);
    });

    if (!matches.length) {
      const none = el("div", { style: { padding: "10px 12px", fontSize: "12px", color: "#a39688" } },
        currentName ? "No matches in roster." : "No matches. Add providers in Admin.");
      dropdown.appendChild(none);
    }

    wrap.appendChild(dropdown);
  }

  input.addEventListener("focus", () => showDropdown(input.value));
  input.addEventListener("input", () => showDropdown(input.value));
  input.addEventListener("blur",  () => setTimeout(() => {
    closeDropdown();
    // Restore empty state if no provider assigned
    if (card && !currentName && !(boardData[roomId(loc)]||{}).provider) {
      card.classList.add("empty"); card.classList.remove("editing");
    }
    onDone();
  }, 150));
  input.addEventListener("keydown", async e => {
    if (e.key === "Escape") { closeDropdown(); onDone(); return; }
    if (e.key === "Enter" || e.key === "Tab") {
      e.preventDefault();
      const isTab = e.key === "Tab";
      const query = input.value.trim();
      const matches = query ? roster.filter(n => rosterMatches(n, query)) : roster;
      if (matches.length > 0) {
        closeDropdown();
        await assignProvider(loc, matches[0]);
        if (isTab && onTab) onTab();
        else onDone();
      } else {
        // No match â€” just move on
        if (isTab && onTab) { closeDropdown(); onDone(); onTab(); }
      }
    }
  });

  wrap.appendChild(input);
  setTimeout(() => { input.focus(); showDropdown(""); }, 30);
  return wrap;
}

// â”€â”€â”€ Render: No-break slot card (half-height, name only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNoBreakCard(slot, isDisplay = false, tabOrder = null, tabIdx = null) {
  const id       = roomId("nb_" + slot);
  const room     = boardData[id] || {};
  const provider = room.provider || null;

  const card = el("div", { class: "or-card no-break-card" + (isDisplay ? " display-card" : "") + (!provider ? " empty" : "") });

  const body = el("div", { class: "card-body" });
  body.appendChild(el("div", { class: "room-label no-break-label" }, slot));

  let editingProvider = false;

  function openEdit() { editingProvider = true; renderProviderArea(); }

  // Register in tab order so next card can trigger this one
  if (tabOrder !== null && tabIdx !== null) tabOrder[tabIdx] = { openEdit };

  function onTab() {
    // Focus the next card in tab order
    if (tabOrder) {
      const next = tabOrder[tabIdx + 1];
      if (next) setTimeout(() => next.openEdit(), 50);
    }
  }

  function renderProviderArea() {
    const existing = body.querySelector(".provider-name-btn, .provider-input-wrap");
    if (existing) existing.remove();
    if (editingProvider) {
      body.appendChild(buildProviderInput(provider, "nb_" + slot, card, () => {
        editingProvider = false; renderProviderArea();
      }, onTab));
    } else {
      const nameBtn = el("button", {
        class: "provider-name-btn" + (!provider ? " empty" : ""),
        onClick: openEdit
      }, provider || "Tap to assign");
      body.appendChild(nameBtn);
    }
  }
  renderProviderArea();

  card.appendChild(el("div", { class: "card-inner" }, body));
  return card;
}

// â”€â”€â”€ Render: OR card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCard(loc, isDisplay = false, tabOrder = null, tabIdx = null) {
  const id       = roomId(loc);
  const room     = boardData[id] || {};
  const provider = room.provider || null;
  const breaks   = room.breaks   || {};
  const isHold   = !!room.hold;
  const isReq    = !!room.requesting;
  const holdAt   = room.holdAt || null;
  const now      = Date.now();
  const holdAge  = isHold && holdAt ? now - holdAt : 0;
  const isWarn   = isHold && holdAge >= HOLD_WARN_MS;

  // Hold countdown label â€” shown inside the button itself
  let holdBtnLabel = "Hold";
  if (isHold && holdAt) {
    const remaining = Math.max(0, HOLD_CLEAR_MS - holdAge);
    const mins = Math.ceil(remaining / 60000);
    holdBtnLabel = (isWarn ? "âš ï¸ " : "âœ‹ ") + mins + "m";
  }

  let cardClass = "or-card" + (isDisplay ? " display-card" : "");
  if (!provider)                      cardClass += " empty";
  else if (isHold && isWarn && isReq) cardClass += " hold-warn requesting";
  else if (isHold && isWarn)          cardClass += " hold-warn";
  else if (isHold && isReq)           cardClass += " hold requesting";
  else if (isHold)                    cardClass += " hold";
  else if (isReq)                     cardClass += " requesting";

  const card = el("div", { class: cardClass });

  // On mobile: show requesting banner. On display: just show green card + name suffix.

  // â”€â”€ Side buttons â”€â”€
  const side = el("div", { class: "card-side" });

  if (provider) {
    // Hold button â€” countdown lives inside the button
    const holdBtn = el("button", {
      class: "side-btn" + (isHold ? (isWarn ? " hold-warn" : " hold-on") : ""),
      onClick: () => toggleHold(loc)
    }, holdBtnLabel);
    side.appendChild(holdBtn);

    // Request button
    const reqBtn = el("button", {
      class: "side-btn" + (isReq ? " request-on" : ""),
      onClick: () => toggleRequesting(loc)
    }, isReq ? "ðŸ”” Sent" : "Request");
    side.appendChild(reqBtn);
  }

  // â”€â”€ Card body â€” vertical stack: room â†’ provider â†’ pills â”€â”€
  const body = el("div", { class: "card-body" });

  // Room label
  body.appendChild(el("div", { class: "room-label" }, loc));

  // Provider name / input
  let editingProvider = false;

  function openEdit() { editingProvider = true; renderProviderArea(); }
  if (tabOrder !== null && tabIdx !== null) tabOrder[tabIdx] = { openEdit };

  function onTab() {
    if (tabOrder) {
      const next = tabOrder[tabIdx + 1];
      if (next) setTimeout(() => next.openEdit(), 50);
    }
  }

  function renderProviderArea() {
    // Remove old provider area if present
    const existing = body.querySelector(".provider-name-btn, .provider-input-wrap");
    if (existing) existing.remove();
    const existingPills = body.querySelector(".pill-row");
    if (existingPills) existingPills.remove();

    if (editingProvider) {
      body.appendChild(buildProviderInput(provider, loc, card, () => {
        editingProvider = false;
        renderProviderArea();
      }, isDisplay ? null : onTab));
    } else {
      const nameLabel = provider
        ? (isReq && isDisplay ? provider + " â€” ðŸ”” requesting" : provider)
        : "Tap to assign provider";
      const nameBtn = el("button", {
        class: "provider-name-btn" + (!provider ? " empty" : "") + (isReq && isDisplay ? " requesting-name" : ""),
        onClick: openEdit
      }, nameLabel);
      // On mobile, show requesting banner above name
      if (isReq && provider && !isDisplay) {
        body.appendChild(el("div", { class: "requesting-banner" }, "ðŸ”” requesting a break"));
      }
      body.appendChild(nameBtn);

      // Break pills â€” only if occupied
      if (provider) {
        const pillRow = el("div", { class: "pill-row" });
        BREAKS.forEach(b => {
          const done = !!breaks[b.id];
          const pill = el("button", {
            class: "pill" + (done ? " done" : ""),
            onClick: () => toggleBreak(loc, b.id)
          }, done ? `âœ“ ${b.label}` : b.label);
          pillRow.appendChild(pill);
        });
        body.appendChild(pillRow);
      }
    }
  }
  renderProviderArea();

  card.appendChild(el("div", { class: "card-inner" }, body, side));
  return card;
}

// â”€â”€â”€ Request notification (for display mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shownNotifications = new Set();

function checkRequestNotifications() {
  if (!isDisplayMode) return;
  Object.entries(boardData).forEach(([id, room]) => {
    if (room.requesting && room.provider && !shownNotifications.has(id)) {
      shownNotifications.add(id);
      showRequestNotification(room.location || id, room.provider);
    }
    if (!room.requesting) shownNotifications.delete(id);
  });
}

function showRequestNotification(loc, providerName) {
  const DURATION = 15000; // 15 seconds
  const notif = el("div", { class: "request-notification" },
    el("div", { class: "notif-room" }, "ðŸ”” " + loc),
    el("div", { class: "notif-sub"  }, providerName + " is requesting a break"),
    el("div", { class: "notif-timer-bar" }),
    el("button", { class: "notif-dismiss", onClick: () => { clearTimeout(autoTimer); notif.remove(); } }, "Dismiss"),
  );
  document.body.appendChild(notif);

  // Animate the timer bar shrinking
  const bar = notif.querySelector(".notif-timer-bar");
  bar.style.transition = `width ${DURATION}ms linear`;
  setTimeout(() => { bar.style.width = "0%"; }, 50);

  const autoTimer = setTimeout(() => { if (notif.parentNode) notif.remove(); }, DURATION);
}

// â”€â”€â”€ Render: Board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoard() {
  if (!session?.deptCode) { renderCodeScreen(); return; }
  document.body.classList.remove("display-mode");
  checkRequestNotifications();

  const visibleLocs = locations;

  // Summary counts
  const allRooms  = locations.map(l => boardData[roomId(l)] || {});
  const occupied  = allRooms.filter(r => r.provider).length;
  const amLeft    = allRooms.filter(r => r.provider && !(r.breaks||{}).am).length;
  const lunchLeft = allRooms.filter(r => r.provider && !(r.breaks||{}).lunch).length;
  const pmLeft    = allRooms.filter(r => r.provider && !(r.breaks||{}).pm).length;

  function makeChip(count, label, bg, color, dot, filterId) {
    const has = count > 0;
    const isActive = activeFilter === filterId;
    const chip = el("div", {
      class: "chip" + (!filterId ? " filter-rooms" : "") + (isActive ? " active-filter" : ""),
      style: { background: has ? bg : "#f1ede8", color: has ? color : "#c4b8ad" }
    },
      el("span", { class: "chip-dot", style: { background: has ? dot : "#d4ccc6" } }),
      el("span", { class: "chip-count" }, String(count)),
      el("span", {}, label + (isActive ? " âœ•" : "")),
    );
    if (filterId) {
      chip.addEventListener("click", () => {
        activeFilter = (activeFilter === filterId) ? null : filterId;
        renderBoard();
      });
    }
    return chip;
  }

  const chips = [
    makeChip(occupied,  "Rooms",          "#fef3c7", "#b45309", "#f59e0b", null),
    makeChip(amLeft,    "AM remaining",   "#fee2e2", "#dc2626", "#f87171", "am"),
    makeChip(lunchLeft, "Lunch remaining","#e0f2fe", "#0369a1", "#38bdf8", "lunch"),
    makeChip(pmLeft,    "PM remaining",   "#ede9fe", "#7c3aed", "#a78bfa", "pm"),
  ];

  // Build tab-order list: no-break slots first, then regular ORs
  const tabOrder = [];  // array of { openEdit: fn } in visual order â€” no-break slots first, then ORs
  const noBreakCards = noBreakSlots.map((s, i) => renderNoBreakCard(s, false, tabOrder, i));
  const cards = visibleLocs.map((loc, i) => {
    const card = renderCard(loc, false, tabOrder, noBreakSlots.length + i);
    if (activeFilter) {
      const room = boardData[roomId(loc)] || {};
      if (room.provider && (room.breaks||{})[activeFilter]) {
        card.classList.add("filter-done");
      }
    }
    return card;
  });



  const app = document.getElementById("app");
  app.innerHTML = "";
  app.appendChild(el("div", {},
    el("header", { class: "header" },
      el("div", { class: "header-inner" },
        el("div", { class: "logo-wrap" },
          el("div", { class: "logo-icon" }, "ðŸ’¨"),
          el("div", {},
            el("div", { class: "logo-text" }, "Gas Breaker"),
            el("div", { class: "logo-sub"  }, session.deptName + " Â· " + new Date().toLocaleDateString([], { weekday: "long", month: "long", day: "numeric" })),
          ),
        ),
        el("div", { class: "header-right" },
          el("a", { class: "display-link", href: "?display=1", target: "_blank" }, "ðŸ–¥ Display"),
          el("div", { class: "sync-pip" }),
          el("button", { class: "logout-btn", onClick: () => {
            sessionStorage.removeItem(SESSION_KEY);
            session = null; boardData = {}; locations = [...DEFAULT_LOCATIONS]; noBreakSlots = []; roster = [];
            if (unsubBoard)  { unsubBoard();  unsubBoard  = null; }
            if (unsubConfig) { unsubConfig(); unsubConfig = null; }
            renderCodeScreen();
          }}, "Leave"),
        ),
      )
    ),
    el("div", { class: "summary-bar" }, ...chips),
    el("main", { class: "main" },
      noBreakSlots.length ? el("div", { class: "no-break-section" },
        ...noBreakCards,
        el("hr", { class: "or-section-divider" }),
      ) : null,
      ...cards,
    ),
  ));

  // Refresh every 30s to update hold timers
  clearTimeout(window._holdRefreshTimer);
  window._holdRefreshTimer = setTimeout(() => { if (document.querySelector(".main")) renderBoard(); }, 30000);
}

// â”€â”€â”€ Render: Coordinator display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDisplay() {
  isDisplayMode = true;
  document.body.classList.add("display-mode");
  checkRequestNotifications();

  const visibleLocs = locations;

  const noBreakCards = noBreakSlots.map(s => renderNoBreakCard(s, true));
  const cards = visibleLocs.map(loc => {
    const card = renderCard(loc, true);
    if (activeFilter) {
      const room = boardData[roomId(loc)] || {};
      if (room.provider) {
        if ((room.breaks||{})[activeFilter]) {
          card.classList.add("filter-done");   // dim: already got this break
        } else {
          card.classList.add("filter-needs");  // highlight: still needs this break
        }
      }
    }
    return card;
  });

  const dAllRooms  = locations.map(l => boardData[roomId(l)] || {});
  const dOccupied  = dAllRooms.filter(r => r.provider).length;
  const dAmLeft    = dAllRooms.filter(r => r.provider && !(r.breaks||{}).am).length;
  const dLunchLeft = dAllRooms.filter(r => r.provider && !(r.breaks||{}).lunch).length;
  const dPmLeft    = dAllRooms.filter(r => r.provider && !(r.breaks||{}).pm).length;

  const app = document.getElementById("app");
  app.innerHTML = "";
  app.appendChild(el("div", {},
    el("header", { class: "header" },
      el("div", { class: "header-inner" },
        el("div", { class: "logo-wrap" },
          el("div", { class: "logo-icon" }, "ðŸ’¨"),
          el("div", {},
            el("div", { class: "logo-text" }, "Gas Breaker â€” " + session.deptName),
            el("div", { class: "logo-sub"  }, "Coordinator Display Â· " + new Date().toLocaleDateString([], { weekday: "long", month: "long", day: "numeric" })),
          ),
        ),
        el("div", { class: "header-right" },
          el("div", { class: "sync-pip" }),

        ),
      )
    ),
    el("div", { class: "summary-bar", style: { maxWidth: "none" } },
      ...[
        [dOccupied,  "Rooms",           "#fef3c7", "#b45309", "#f59e0b", null],
        [dAmLeft,    "AM remaining",    "#fee2e2", "#dc2626", "#f87171", "am"],
        [dLunchLeft, "Lunch remaining", "#e0f2fe", "#0369a1", "#38bdf8", "lunch"],
        [dPmLeft,    "PM remaining",    "#ede9fe", "#7c3aed", "#a78bfa", "pm"],
      ].map(([count, label, bg, color, dot, filterId]) => {
        const has = count > 0;
        const isActive = activeFilter === filterId;
        const chip = el("div", {
          class: "chip" + (!filterId ? " filter-rooms" : "") + (isActive ? " active-filter" : ""),
          style: { background: has ? bg : "#2d2825", color: has ? color : "#4a4240", border: "2px solid " + (isActive ? color : "transparent") }
        },
          el("span", { class: "chip-dot", style: { background: has ? dot : "#3d3530" } }),
          el("span", { class: "chip-count" }, String(count)),
          el("span", {}, label + (isActive ? " âœ•" : "")),
        );
        if (filterId) chip.addEventListener("click", () => { activeFilter = (activeFilter === filterId) ? null : filterId; renderDisplay(); });
        return chip;
      })
    ),
    el("div", { class: "display-outer" },
      noBreakSlots.length ? el("div", { class: "display-nobreak-row" }, ...noBreakCards) : null,
      noBreakSlots.length ? el("hr", { class: "display-divider" }) : null,
      el("div", { class: "display-wrap" }, ...cards),
    ),
  ));

  clearTimeout(window._holdRefreshTimer);
  window._holdRefreshTimer = setTimeout(() => { if (document.querySelector(".display-outer")) renderDisplay(); }, 30000);
}

// â”€â”€â”€ Render: Code screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCodeScreen(errorMsg = "") {
  const input = el("input", { class: "text-input code-input", placeholder: "Enter code", type: "text", autocomplete: "off" });
  input.addEventListener("keydown", e => { if (e.key === "Enter") tryCode(); });

  async function tryCode() {
    const code = input.value.trim().toUpperCase();
    if (code === ADMIN_CODE) {
      session = { isAdmin: true };
      // If departments already loaded, go straight to admin
      if (Object.keys(departments).length > 0) {
        renderAdminDeptSelect();
      } else {
        subscribeToDepartments(() => renderAdminDeptSelect());
      }
      return;
    }
    if (departments[code]) {
      session = { deptCode: code, deptName: departments[code] };
      sessionStorage.setItem(SESSION_KEY, JSON.stringify(session));
      await loadConfig(code);
      const goDisplay = window._postLoginDisplay || new URLSearchParams(window.location.search).has("display");
      if (goDisplay) {
        unsubBoard && unsubBoard();
        unsubBoard = onValue(boardRef(code), snap => {
          boardData = snap.val() || {};
          checkAutoUnhold();
          renderDisplay();
        });
      } else {
        subscribeToBoard(code);
      }
    } else {
      renderCodeScreen("Incorrect code. Check the department board.");
    }
  }

  document.getElementById("app").innerHTML = "";
  document.getElementById("app").appendChild(
    el("div", { class: "auth-root" },
      el("div", { class: "auth-card" },
        el("div", { style: { fontSize: "48px", marginBottom: "8px" } }, "ðŸ’¨"),
        el("div", { class: "auth-title" }, "Gas Breaker"),
        el("div", { class: "auth-sub"   }, "Anesthesia Break Coordination"),
        el("div", { class: "auth-divider" }),
        el("label", { class: "field-label" }, "Department Code"),
        input,
        errorMsg ? el("div", { class: "error-msg" }, errorMsg) : null,
        el("button", { class: "btn-primary mt", onClick: tryCode }, "Enter â†’"),
      )
    )
  );
  input.focus();
}

// â”€â”€â”€ Admin: dept select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAdminDeptSelect() {
  const deptList = Object.entries(departments);
  const select = deptList.length
    ? el("select", { class: "text-input" },
        ...deptList.map(([code, name]) => {
          const o = document.createElement("option");
          o.value = code; o.textContent = `${name} (${code})`; return o;
        })
      )
    : null;

  document.getElementById("app").innerHTML = "";
  document.getElementById("app").appendChild(
    el("div", { class: "auth-root" },
      el("div", { class: "auth-card" },
        el("div", { style: { fontSize: "48px", marginBottom: "8px" } }, "âš™ï¸"),
        el("div", { class: "auth-title" }, "Admin"),
        el("div", { class: "auth-sub"   }, "Select a department to manage"),
        el("div", { class: "auth-divider" }),
        select
          ? el("div", {},
              el("label", { class: "field-label" }, "Department"),
              select,
              el("button", { class: "btn-primary full", onClick: async () => {
                const code = select.value;
                session.deptCode = code;
                session.deptName = departments[code];
                await loadConfig(code);
                renderAdminPage(code);
              }}, "Manage â†’"),
            )
          : el("div", { style: { color: "#a39688", fontSize: "13px", margin: "10px 0" } }, "No departments yet."),
        el("button", { class: "btn-ghost", style: { width: "100%", marginTop: "10px" }, onClick: () => renderAdminPage(null) }, "Manage Departments â†’"),
        el("button", { class: "btn-view-only", style: { background:"none", border:"none", color:"#a39688", fontSize:"13px", fontWeight:"700", textDecoration:"underline", marginTop:"10px", cursor:"pointer", width:"100%" }, onClick: () => renderCodeScreen() }, "â† Back"),
      )
    )
  );
}

async function loadConfig(code) {
  return new Promise(resolve => {
    let done = false;
    const unsub = onValue(configRef(code), snap => {
      const cfg = snap.val() || {};
      locations    = cfg.locations    ? Object.values(cfg.locations)    : [...DEFAULT_LOCATIONS];
      noBreakSlots = cfg.noBreakSlots ? Object.values(cfg.noBreakSlots) : [];
      roster       = cfg.roster       ? Object.values(cfg.roster).sort() : [];
      if (!done) { done = true; resolve(); }
    });
    setTimeout(() => { if (!done) { done = true; resolve(); } }, 3000);
  });
}

// â”€â”€â”€ Admin page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAdminPage(deptCode) {
  const isDept = !!deptCode;
  const app = document.getElementById("app");
  app.innerHTML = "";

  // â”€â”€ Drag list builder â”€â”€
  function buildDraggableList(items, onReorder, renderItem) {
    const list = el("div", { class: "admin-list" });
    let dragSrc = null;

    function rebuild(arr) {
      list.innerHTML = "";
      if (!arr.length) {
        // empty state â€” no items to show, leave blank (parent handles empty msg)
        return;
      }
      arr.forEach((item, i) => {
        const row = el("div", { class: "admin-list-item" });
        row.setAttribute("draggable", "true");
        const handle = el("span", { class: "drag-handle" }, "â ¿");
        row.appendChild(handle);
        const content = renderItem(item, arr, () => rebuild(arr));
        row.appendChild(content);
        row.addEventListener("dragstart", e => { dragSrc = i; setTimeout(() => row.classList.add("dragging"), 0); e.dataTransfer.effectAllowed = "move"; });
        row.addEventListener("dragend",   () => row.classList.remove("dragging"));
        row.addEventListener("dragover",  e => { e.preventDefault(); row.classList.add("drag-over"); });
        row.addEventListener("dragleave", () => row.classList.remove("drag-over"));
        row.addEventListener("drop", e => {
          e.preventDefault(); row.classList.remove("drag-over");
          if (dragSrc === null || dragSrc === i) return;
          const newArr = [...arr];
          const [moved] = newArr.splice(dragSrc, 1);
          newArr.splice(i, 0, moved);
          dragSrc = null;
          onReorder(newArr);
          rebuild(newArr);
        });
        list.appendChild(row);
      });
    }
    rebuild(items);
    return { list, rebuild };
  }

  // â”€â”€ Departments section â”€â”€
  function buildDeptSection() {
    const { list } = buildDraggableList(
      Object.entries(departments),
      () => {},
      ([code, name], arr, rebuild) => {
        const newCodeIn = el("input", { class: "admin-add-input", type: "text", placeholder: "New code", style: { flex:"1", fontSize:"12px", padding:"6px 8px", display:"none" } });
        const editBtn = el("button", { class: "btn-ghost", style: { fontSize:"11px", padding:"4px 8px" }, onClick: () => {
          newCodeIn.style.display = newCodeIn.style.display === "none" ? "block" : "none";
          if (newCodeIn.style.display !== "none") newCodeIn.focus();
        }}, "Edit Code");
        newCodeIn.addEventListener("keydown", async e => {
          if (e.key !== "Enter") return;
          const newCode = newCodeIn.value.trim().toUpperCase();
          if (!newCode || newCode === code || departments[newCode]) { showToast("Invalid or duplicate code"); return; }
          await renameDepartmentCode(code, newCode, name);
          showToast(`Code changed to ${newCode}`);
          setTimeout(() => renderAdminPage(null), 400);
        });
        return el("div", { style: { display:"flex", flexDirection:"column", flex:"1", gap:"6px" } },
          el("div", { style: { display:"flex", alignItems:"center", justifyContent:"space-between", gap:"8px" } },
            el("span", {}, name, el("span", { class: "dept-badge" }, code)),
            el("div", { style: { display:"flex", gap:"6px" } },
              editBtn,
              el("button", { class: "btn-danger", onClick: () => showConfirm(
                "Delete Department",
                `Permanently delete "${name}" (${code}) and ALL its board data? This cannot be undone.`,
                async () => { await deleteDepartment(code); showToast(`${name} deleted`); setTimeout(() => renderAdminPage(null), 400); }
              )}, "Delete"),
            ),
          ),
          newCodeIn,
        );
      }
    );

    const codeIn = el("input", { class: "admin-add-input", type: "text", placeholder: "Code (e.g. CARDIAC)", style: { flex:"1" } });
    const nameIn = el("input", { class: "admin-add-input", type: "text", placeholder: "Name (e.g. Cardiac OR)", style: { flex:"2" } });

    async function addDept() {
      const code = codeIn.value.trim().toUpperCase();
      const name = nameIn.value.trim();
      if (!code || !name) return;
      if (departments[code]) { showToast("Code already exists"); return; }
      await saveDepartment(code, name);
      showToast(`${name} added`);
      codeIn.value = ""; nameIn.value = "";
      setTimeout(() => renderAdminPage(null), 400);
    }
    nameIn.addEventListener("keydown", e => { if (e.key === "Enter") addDept(); });

    return el("div", { class: "admin-section" },
      el("div", { class: "admin-section-title" }, "Departments"),
      el("div", { class: "admin-section-sub"   }, "Each department gets its own board and code."),
      Object.keys(departments).length ? list : el("div", { style: { color:"#a39688", fontSize:"13px", marginBottom:"14px" } }, "No departments yet."),
      el("div", { class: "admin-add-row" }, codeIn, nameIn, el("button", { class: "btn-primary", onClick: addDept }, "Add")),
    );
  }

  // â”€â”€ Locations section â”€â”€
  function buildLocSection() {
    let locs = [...locations];
    const { list, rebuild } = buildDraggableList(
      locs,
      async (newOrder) => { locs = newOrder; await saveLocations(newOrder); },
      (loc, arr, rebuildFn) => el("div", { style: { display:"flex", alignItems:"center", justifyContent:"space-between", flex:"1", gap:"8px" } },
        el("span", {}, loc),
        el("button", { class: "btn-danger", onClick: async () => {
          locs = locs.filter(l => l !== loc);
          await saveLocations(locs); rebuildFn(locs); showToast(`${loc} removed`);
        }}, "Remove"),
      )
    );

    const locIn = el("input", { class: "admin-add-input", type: "text", placeholder: "e.g. Cardiac OR 1", style: { flex:"1" } });
    async function addLoc() {
      const val = locIn.value.trim();
      if (!val || locs.includes(val)) return;
      const newLocs = [...locs, val];
      await saveLocations(newLocs); locs = newLocs; rebuild(newLocs); locIn.value = ""; showToast(`${val} added`);
    }
    locIn.addEventListener("keydown", e => { if (e.key === "Enter") addLoc(); });

    return el("div", { class: "admin-section" },
      el("div", { class: "admin-section-title" }, "Locations"),
      el("div", { class: "admin-section-sub"   }, "Drag â ¿ to reorder. Changes apply immediately for all users."),
      list,
      el("div", { class: "admin-add-row" }, locIn, el("button", { class: "btn-primary", onClick: addLoc }, "Add")),
    );
  }

  // â”€â”€ No-break slots section â”€â”€
  function buildNoBreakSection() {
    let slots = [...noBreakSlots];
    const { list, rebuild } = buildDraggableList(
      slots,
      async (newOrder) => { slots = newOrder; await saveNoBreakSlots(newOrder); },
      (slot, arr, rebuildFn) => el("div", { style: { display:"flex", alignItems:"center", justifyContent:"space-between", flex:"1", gap:"8px" } },
        el("span", {}, slot),
        el("button", { class: "btn-danger", onClick: async () => {
          slots = slots.filter(s => s !== slot);
          await saveNoBreakSlots(slots); rebuildFn(slots); showToast(`${slot} removed`);
        }}, "Remove"),
      )
    );

    const slotIn = el("input", { class: "admin-add-input", type: "text", placeholder: "e.g. Breaker 1, Float", style: { flex:"1" } });
    async function addSlot() {
      const val = slotIn.value.trim();
      if (!val || slots.includes(val)) return;
      const newSlots = [...slots, val];
      await saveNoBreakSlots(newSlots); slots = newSlots; rebuild(newSlots); slotIn.value = ""; showToast(`${val} added`);
    }
    slotIn.addEventListener("keydown", e => { if (e.key === "Enter") addSlot(); });

    const emptyMsg = el("div", { style: { color:"#a39688", fontSize:"13px", marginBottom:"14px" } }, "No slots yet.");
    if (!slots.length) list.appendChild(emptyMsg);
    return el("div", { class: "admin-section" },
      el("div", { class: "admin-section-title" }, "No-Break Slots"),
      el("div", { class: "admin-section-sub" }, "Slots for breakers or others who don't need breaks. Appear at the top of the board for tracking only."),
      list,
      el("div", { class: "admin-add-row" }, slotIn, el("button", { class: "btn-primary", onClick: addSlot }, "Add")),
    );
  }

  // â”€â”€ Roster section â”€â”€
  function buildRosterSection() {
    let ros = [...roster];
    const { list, rebuild } = buildDraggableList(
      ros,
      () => {},
      (name, arr, rebuildFn) => el("div", { style: { display:"flex", alignItems:"center", justifyContent:"space-between", flex:"1", gap:"8px" } },
        el("span", {}, name),
        el("button", { class: "btn-danger", onClick: async () => {
          await deleteRosterEntry(name); ros = ros.filter(n => n !== name); rebuildFn([...ros]); showToast(`${name} removed`);
        }}, "Remove"),
      )
    );

    const nameIn = el("input", { class: "admin-add-input", type: "text", placeholder: "Last, First (e.g. Smith, John)", style: { flex:"1" } });
    async function addName() {
      const val = nameIn.value.trim();
      if (!val || ros.includes(val)) return;
      await saveRosterEntry(val); ros = [...ros, val].sort(); rebuild(ros); nameIn.value = ""; showToast(`${val} added`);
    }
    nameIn.addEventListener("keydown", e => { if (e.key === "Enter") addName(); });

    return el("div", { class: "admin-section" },
      el("div", { class: "admin-section-title" }, "Provider Roster"),
      el("div", { class: "admin-section-sub"   }, "Names appear as suggestions when assigning a provider. Format: Last, First."),
      list,
      el("div", { class: "admin-add-row" }, nameIn, el("button", { class: "btn-primary", onClick: addName }, "Add")),
    );
  }

  // â”€â”€ Clear board section â”€â”€
  function buildClearSection() {
    return el("div", { class: "admin-section" },
      el("div", { class: "admin-section-title" }, "Clear Board"),
      el("div", { class: "admin-section-sub"   }, "Removes all providers from today's board immediately."),
      el("button", { class: "btn-warn", onClick: () => showConfirm(
        "Clear Today's Board",
        `Remove all providers from the ${session.deptName} board right now? This cannot be undone.`,
        async () => { await clearBoard(); showToast("Board cleared"); }
      )}, "ðŸ—‘ Clear Today's Board"),
    );
  }

  app.appendChild(el("div", {},
    el("header", { class: "header" },
      el("div", { class: "header-inner" },
        el("button", { class: "admin-back-btn", onClick: () => isDept ? renderAdminDeptSelect() : renderCodeScreen() }, isDept ? "â† Departments" : "â† Back"),
        el("div", { class: "header-right" },
          el("span", { class: "dept-name" }, isDept ? `Admin Â· ${session.deptName}` : "Admin Â· Departments"),
        ),
      )
    ),
    el("div", { class: "admin-root" },
      el("div", { style: { fontFamily:"'Libre Baskerville', serif", fontWeight:"700", fontSize:"22px", color:"#2d2420", marginBottom:"4px" } }, "âš™ï¸ " + (isDept ? session.deptName : "Departments")),
      el("div", { style: { fontSize:"13px", color:"#a39688", marginBottom:"20px" } }, isDept ? "Department settings" : "Manage all departments"),
      isDept ? buildLocSection()        : buildDeptSection(),
      isDept ? buildNoBreakSection()    : null,
      isDept ? buildRosterSection()     : null,
      isDept ? buildClearSection()      : null,
    ),
  ));
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  const isDisplay = new URLSearchParams(window.location.search).has("display");

  // Load departments first
  await new Promise(resolve => {
    let done = false;
    subscribeToDepartments(() => { if (!done) { done = true; resolve(); } });
    setTimeout(() => { if (!done) { done = true; resolve(); } }, 3000);
  });

  // Restore session
  try {
    const stored = sessionStorage.getItem(SESSION_KEY);
    if (stored) {
      const s = JSON.parse(stored);
      if (s?.deptCode && departments[s.deptCode]) {
        session = s;
        await loadConfig(s.deptCode);
        subscribeToBoard(s.deptCode);
        if (isDisplay) {
          // board listener will call renderBoard; override with display render
          unsubBoard && unsubBoard();
          unsubBoard = onValue(boardRef(s.deptCode), snap => {
            boardData = snap.val() || {};
            checkAutoUnhold();
            renderDisplay();
          });
        }
        return;
      }
    }
  } catch {}

  // Clean up any old session keys
  sessionStorage.removeItem("gasbreaker-session-v3");

  // No valid session â€” show code screen
  // After code entry, if ?display=1 is in URL, go to display mode
  window._postLoginDisplay = isDisplay;
  renderCodeScreen();
})();


</script>
</body>
</html>
